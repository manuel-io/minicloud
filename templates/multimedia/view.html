{% extends "layout.html" %}
{% from "_macros.html" import aside, tinymce  with context %}
{% from "multimedia/_macros.html" import nav with context %}

{% block aside %}
  {{ aside() }}
{% endblock %}

{% block nav %}
  {{ nav("view") }}
{% endblock %}

{% block header %}
{% endblock %}

{% block section %}
  <section id="multimedia" class="view">
    <h2 class="top"><a id="return" class="back" href="{{ url_for('multimedia.show') }}">Zur√ºck</a></h2>
    <h2>{{ media.title }}</h2>

    <section class="media" style="position:relative;">
      {% if media.mime in config["ftypes"]["audio"] %}
        <audio id="audio" controls title="{{ media.title }}" title="{{ media.title }}" data-uuid="{{ media.uuid }}" data-last="">
          {% for source in sources %}
            <source src="{{ source.url }}" type="{{ source.mime }}" />
          {% endfor %}
        </audio>

      {% elif media.mime in config["ftypes"]["video"] %}

        <video id="video" controls controlsList="fullscreen download" title="{{ media.title }}" data-uuid="{{ media.uuid }}" data-last="">
          {% for source in sources %}
            <source src="{{ source.url }}" type="{{ source.mime }}" />
          {% endfor %}
        </video>
      {% endif %}

      <input class="toggle" type="checkbox" name="capture">
      <section id="capture" class="dialog">
        <main>
          <canvas class="capture" onclick="close_dialog('capture');"></canvas>
          <form action="{{ url_for('multimedia.capture', uuid=media.uuid) }}" method="post" onsubmit="handle_capture_form(event);">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="canvas">
            <input type="submit" value="Save">
          </form>
        </main>
      </section>
    </section>

    {% if current_user.admin %}
      {% if media.mime in config["ftypes"]["video"] %}
        <nav>
          <form method="post" onsubmit="handle_capture_dialog(event);">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="submit" value="Caption">
          </form>
        </nav>
      {% endif %}

      <form action="{{ url_for('multimedia.edit', uuid = media.uuid) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="type" value="{{ media.type }}">

        <div class="group">
          <fieldset>
            <label>Category:</label>
            <input type="text" name="category" value="{{ media.category }}" />
          </fieldset>

          <fieldset>
            <label>Title:</label>
            <input type="text" name="title" value="{{ media.title }}" required />
          </fieldset>

          <fieldset>
            <label>Description:</label>
            <textarea name="description"></textarea>
          </fieldset>

          <fieldset>
            <label>Director:</label>
            <input type="text" name="director" value="{{ media.director }}" />
          </fieldset>

          <fieldset>
            <label>Cast:</label>
            <div class="tags" onclick="tags_set_focus(event);">
              <input type="hidden" name="tags">
              {% if media.actors %}
                {% for actor in media.actors %}
                  <div class="tag">{{ actor }}</div>
                {% endfor %}
              {% endif %}
              <div class="newtag">
                <input type="text" name="tag" onkeydown="tags_prevent_submit(event)" onkeyup="tags_handle_input(event, 'tags');">
              </div>
            </div>
          </fieldset>

          <fieldset>
            <label>Year:</label>
            <input type="number" name="year" min="1900" max="2090" step="1" value="{{ media.year }}" required />
          </fieldset>

          <fieldset>
            <input type="submit" value="Edit">
          </fieldset>
        </div>
      </form>

      <nav>
        <form action="{{ url_for('multimedia.delete', uuid = media.uuid) }}" method="post" onsubmit="handle_delete_check(event);">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="submit" value="Delete">
        </form>
      </nav>
    {% endif %}
  </section>

  <script>
    let hash = window.location.hash.substr(1);
    let ret = document.getElementById('return');
    ret.href = ret.href + `#${hash}`;

    let set_active = (media) => {
      let data = new FormData();
      let url = '{{ url_for('auths.renew', token = auth) }}';
      data.append('csrf_token', '{{ csrf_token() }}');
      send_status(url, data, (e) => alive_loop(media));
    }

    let alive_loop = (media) => {
      if (!media.paused) {
        window.setTimeout(() => {
          set_active(media);
        }, 150000);
      }
    }

    let save_current = (media) => {
      let last = media.dataset.last;
      let current = parseInt(media.currentTime);

      if (last) last = parseInt(last);
      else last = 0;
      if (last - 30 > current || last + 30 < current ) {
        let value = media.id + '$' + media.dataset.uuid + '$' + current + '$' + parseInt(media.duration);
        let data = new FormData();
        let url = '{{ url_for('users.set_media') }}';

        media.dataset.last = current;
        data.append('csrf_token', '{{ csrf_token() }}');
        data.append('media', value);
        send_upload(url, data);
      }
    };

    let load_current = (media) => {
      media.focus();
      let [type, uuid, current, duration] = '{{ media.status }}'.split('$');
      if (uuid == '{{ media.uuid }}') {
        media.dataset.last = current;
        media.currentTime = current;
      }
    };

    {% if media.mime in config.ftypes.audio %}
      let audio = document.getElementById('audio');

      {% if proxy %}
        audio.setAttribute('crossorigin', 'anonymous');
      {% endif %}

      audio.onloadeddata = (e) => load_current(audio);
      audio.onpause = (e) => save_current(audio);
      audio.onplay = (e) => set_active(audio);
    {% endif %}

    {% if media.mime in config.ftypes.video %}
      let video = document.getElementById('video');

      {% if proxy %}
        video.setAttribute('crossorigin', 'anonymous');
      {% endif %}

      video.onloadeddata = (e) => load_current(video);
      video.onpause = (e) => save_current(video);
      video.onplay = (e) => set_active(video);
    {% endif %}

    window.onload = (e) => {
      let target = document.querySelector('#multimedia .tags');
      tags_set_input(target, 'tags');
    };
  </script>
{% endblock %}
